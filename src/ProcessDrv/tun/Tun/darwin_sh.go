//go:build darwin
// +build darwin

package Tun

// sh1 æ˜¯æ¢å¤é»˜è®¤ç½‘å…³çš„æ–¹å¼ï¼Œè¾ƒå¿«ï¼Œç¨³å®šæ€§æœªçŸ¥
const sh1 = `#!/bin/bash

# ==============================
# ðŸ›  SunnyTunCancel.shï¼ˆdaemon ç‰ˆï¼‰
# åŠŸèƒ½ï¼šåŽå°ç›‘æŽ§ç›®æ ‡è¿›ç¨‹ï¼Œå½“è¿›ç¨‹é€€å‡ºæ—¶è‡ªåŠ¨æ¢å¤é»˜è®¤ç½‘å…³
# ==============================

LOG=/tmp/SunnyTunCancel.log                         # æ—¥å¿—
PIDFILE=/tmp/SunnyTunCancel.pid                     # PID æ–‡ä»¶

# ----------------------------------
# ðŸŒ€ é¦–æ¬¡è¿›å…¥ï¼šç”¨ daemon çœŸæ­£å®ˆæŠ¤ï¼ˆæ—  TTYã€æ—  nohup æŠ¥é”™ï¼‰
# ----------------------------------
if [ -z "$DISOWNED" ]; then                         # å¦‚æžœæœªå®ˆæŠ¤
    export DISOWNED=1                               # æ ‡è®°ï¼Œé˜²é€’å½’
    /usr/sbin/daemon -f \                           # -f: çˆ¶è¿›ç¨‹ç«‹å³é€€å‡º
        -p "$PIDFILE" \                             # å†™å…¥ PID æ–‡ä»¶
        -o "$LOG" \                                 # æ—¥å¿—è¾“å‡º
        /bin/bash "$0" "$@"                         # ä»¥ bash æ‰§è¡Œæœ¬è„šæœ¬ï¼ˆè¿›å…¥ä¸‹åŠæ®µï¼‰
    exit 0                                          # å¯åŠ¨å™¨é€€å‡º
fi

# ----------------------------------
# ðŸ“Œ å‚æ•°
# ----------------------------------
TARGET_PID=$1                                       # ç›®æ ‡ PID
ORIGINAL_GW=$2                                      # åŽŸé»˜è®¤ç½‘å…³ IP
ORIGINAL_IF=$3                                      # åŽŸæŽ¥å£å
echo "[` + "`" + `date '+%F %T'` + "`" + `] started: EUID=$EUID args=$*" >>"$LOG"
if [ -z "$TARGET_PID" ]; then
    echo "[` + "`" + `date '+%F %T'` + "`" + `] âŒ æœªä¼ å…¥ PID" >>"$LOG"
    exit 1
fi

# ----------------------------------
# ðŸ‘€ ç›‘æŽ§
# ----------------------------------
echo "[` + "`" + `date '+%F %T'` + "`" + `] ðŸ•“ ç›‘æŽ§ PID=$TARGET_PID" >>"$LOG"
while kill -0 "$TARGET_PID" 2>/dev/null; do
    sleep 1
done

# ----------------------------------
# âœ… æ¢å¤è·¯ç”±
# ----------------------------------
echo "[` + "`" + `date '+%F %T'` + "`" + `] âš ï¸ $TARGET_PID é€€å‡ºï¼Œæ¢å¤è·¯ç”±..." >>"$LOG"
route delete default 2>>"$LOG" || true
if [ -n "$ORIGINAL_IF" ]; then
    route -n delete -inet default -ifscope "$ORIGINAL_IF" 2>>"$LOG" || true
fi
if [ -n "$ORIGINAL_GW" ]; then
    route add default "$ORIGINAL_GW" 2>>"$LOG" || true
    echo "[` + "`" + `date '+%F %T'` + "`" + `] âœ… æ¢å¤é»˜è®¤ç½‘å…³ $ORIGINAL_GW" >>"$LOG"
else
    echo "[` + "`" + `date '+%F %T'` + "`" + `] âš ï¸ æœªæä¾› ORIGINAL_GWï¼Œè·³è¿‡æ·»åŠ  default" >>"$LOG"
fi
echo "[` + "`" + `date '+%F %T'` + "`" + `] ðŸŽ¯ å®Œæˆ" >>"$LOG"
exit 0

`

// sh2 æ˜¯é‡å¯ç½‘å¡çš„æ–¹å¼ï¼Œè¾ƒæ…¢ï¼Œç¨³å®šæ€§åº”è¯¥å§£å¥½,å…ˆç”¨sh1ï¼Œè¿™ä¸ªä¹Ÿå…ˆä¿ç•™
const sh2 = `#!/bin/bash

# ==============================
# ðŸ›  SunnyTunCancel.sh (daemon ç‰ˆ)
# åŠŸèƒ½ï¼šåŽå°ç›‘æŽ§ç›®æ ‡è¿›ç¨‹ï¼Œå½“è¿›ç¨‹é€€å‡ºæ—¶è‡ªåŠ¨é‡å¯æ‰€æœ‰ç‰©ç†ç½‘å¡
# ==============================

LOG=/tmp/SunnyTunCancel.log                         # æ—¥å¿—
PIDFILE=/tmp/SunnyTunCancel.pid                     # PID æ–‡ä»¶

# ----------------------------------
# ðŸŒ€ å®ˆæŠ¤è¿›ç¨‹å¯åŠ¨é€»è¾‘ï¼ˆæ›¿ä»£ nohupï¼‰
# ----------------------------------
if [ -z "$DISOWNED" ]; then
    export DISOWNED=1
    /usr/sbin/daemon -f \                    # -f è®©çˆ¶è¿›ç¨‹ç«‹åˆ»é€€å‡ºï¼Œå­è¿›ç¨‹æˆä¸ºçœŸæ­£å®ˆæŠ¤è¿›ç¨‹
        -p "$PIDFILE" \                      # PID å†™å…¥æ–‡ä»¶
        -o "$LOG" \                          # æ—¥å¿—è¾“å‡ºåˆ° LOG
        /bin/bash "$0" "$@"                  # é‡æ–°ä»¥ bash æ‰§è¡Œè„šæœ¬æœ¬èº«
    exit 0
fi

echo "[\$(date '+%F %T')] âœ… å®ˆæŠ¤è¿›ç¨‹å·²å¯åŠ¨ï¼ŒPID=\$\$ï¼Œç›‘æŽ§ PID=\$1" >>"\$LOG"

# ----------------------------------
# ðŸ“Œ èŽ·å–ç›®æ ‡ PID
# ----------------------------------
TARGET_PID=\$1
if [ -z "\$TARGET_PID" ]; then
    echo "[\$(date '+%F %T')] âŒ æœªä¼ å…¥ PID" >>"\$LOG"
    exit 1
fi

# ----------------------------------
# ðŸ” æ£€æŸ¥æ˜¯å¦æ‹¥æœ‰ ROOT æƒé™
# ----------------------------------
if [ "\$EUID" -eq 0 ]; then
    echo "[\$(date '+%F %T')] âœ… å½“å‰è„šæœ¬ä»¥ ROOT æƒé™è¿è¡Œ (EUID=0)" >>"\$LOG"
else
    echo "[\$(date '+%F %T')] âŒ å½“å‰è„šæœ¬æ²¡æœ‰ ROOT æƒé™ (EUID=\$EUID)" >>"\$LOG"
fi

# ----------------------------------
# ðŸ‘€ å¾ªçŽ¯æ£€æµ‹ç›®æ ‡è¿›ç¨‹æ˜¯å¦ä»ç„¶å­˜åœ¨
# ----------------------------------
echo "[\$(date '+%F %T')] ðŸ•“ æ­£åœ¨ç›‘æŽ§è¿›ç¨‹ PID: \$TARGET_PID" >>"\$LOG"
while kill -0 "\$TARGET_PID" 2>/dev/null; do
    sleep 1
done
echo "[\$(date '+%F %T')] âš ï¸ è¿›ç¨‹ \$TARGET_PID å·²é€€å‡ºï¼Œå¼€å§‹é‡å¯æ‰€æœ‰ç½‘å¡..." >>"\$LOG"

# ----------------------------------
# ðŸŒ èŽ·å–æ‰€æœ‰ç½‘å¡ï¼ŒæŽ’é™¤ lo0 å’Œ utun æŽ¥å£
# ----------------------------------
interfaces=\$(ifconfig -l | tr ' ' '\\n' | grep -vE '^lo0\$' | grep -vE '^utun')

if [ -z "\$interfaces" ]; then
    echo "[\$(date '+%F %T')] âŒ æœªæ£€æµ‹åˆ°å¯é‡å¯çš„ç‰©ç†ç½‘å¡" >>"\$LOG"
    exit 0
fi

echo "[\$(date '+%F %T')] ðŸ” æ£€æµ‹åˆ°ç½‘å¡: \$interfaces" >>"\$LOG"

# ----------------------------------
# ðŸ” ä¾æ¬¡é‡å¯æ‰€æœ‰ç½‘å¡
# ----------------------------------
for iface in \$interfaces; do
    echo "[\$(date '+%F %T')] ðŸš§ æ­£åœ¨é‡å¯ç½‘å¡: \$iface" >>"\$LOG"
    ifconfig "\$iface" down >/dev/null 2>&1
    # sleep 1
    ifconfig "\$iface" up >/dev/null 2>&1
    echo "[\$(date '+%F %T')] âœ… \$iface å·²é‡å¯" >>"\$LOG"
done

# ----------------------------------
# ðŸ ç»“æŸ
# ----------------------------------
echo "[\$(date '+%F %T')] ðŸŽ‰ æ‰€æœ‰ç‰©ç†ç½‘å¡é‡å¯å®Œæˆ" >>"\$LOG"
`
